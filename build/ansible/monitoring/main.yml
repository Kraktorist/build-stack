---
- name: Monitoring Configuration
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Read config file
      ansible.builtin.include_vars:
        file: config.yml
        name: config

- name: Monitoring Installation
  block:
    - name: Copy kubeconfig
      hosts: kube_control_plane
      tasks:
        - name: Copy kubeconfig
          ansible.builtin.fetch:
            src: /root/.kube/config
            dest: /root/.kube/config

    - name: Add stable chart repo
      kubernetes.core.helm_repository:
        name: prometheus-community
        repo_url: https://prometheus-community.github.io/helm-charts

    - name: Install prometheus-operator
      kubernetes.core.helm:
        name: prom
        chart_ref: prometheus-community/kube-prometheus-stack 
        release_namespace: monitoring
        values_files:
          - /monitoring/values.yaml
  when: config.monitoring.enabled | bool