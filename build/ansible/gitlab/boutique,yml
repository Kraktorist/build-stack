---
- name: Create GitLab Project {{ item.reponame }}
  community.general.gitlab_project:
    api_url: "{{ gitlab_url }}"
    api_username: "{{ gitlab_user }}"
    api_password: "{{ gitlab_password }}"
    name: "{{ item.reponame }}"
    visibility: internal
    group: "{{ gitlab_group.group.id }}"
  register: project
  tags:
  - never
  - apps

- name: Prepare {{ item.reponame }} repository
  ansible.builtin.shell: |
    repopath={{ item.repopath }}
    reponame={{ item.reponame }}
    rm -rf $reponame
    git clone $repopath $reponame
  when: project.changed
  tags:
  - never
  - apps
  
- name: Push {{ item.reponame }} repository
  ansible.builtin.shell: |
    repopath={{ item.repopath }}
    reponame={{ item.reponame }}
    cd $reponame
    git add .
    git commit -m "reconfiguring manifests"
    git remote add gitlab-origin http://{{ gitlab_user }}:{{ gitlab_password }}@{{ gitlab_host }}/{{ gitlab_group.group.name }}/${reponame}.git
    git push --all gitlab-origin
    git push --tags gitlab-origin
    cd .. && rm -rf $reponame
  when: project.changed
  tags:
  - never
  - apps