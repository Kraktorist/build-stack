- name: Boutique Gitlab Runner
  hosts: localhost
  tasks:
    - name: Add stable chart repo
      kubernetes.core.helm_repository:
        name: gitlab
        repo_url: https://charts.gitlab.io
      tags:
        - apps_runner
        - never

    - name: Install kubernetes gitlab-runner
      kubernetes.core.helm:
        name: gitlab-runner
        chart_ref: gitlab/gitlab-runner
        release_namespace: gitlab-runner
        values_files: runner_values.yml
        values:
          runnerRegistrationToken: "{{ token }}"
          gitlabUrl: "{{ url }}"
          runners:
            tags: "{{ env }},k8s"
      tags:
        - apps_runner
        - never