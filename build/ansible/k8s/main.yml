- name: Gitlab Runner
  hosts: localhost
  tasks:
    - name: Add stable chart repo
      kubernetes.core.helm_repository:
        name: gitlab
        repo_url: https://charts.gitlab.io

    - name: Create namespace for gitlab-runner
      kubernetes.core.k8s:
        name: gitlab-runner
        api_version: v1
        kind: Namespace
        state: present

    - name: Install kubernetes gitlab-runner
      kubernetes.core.helm:
        name: gitlab-runner
        chart_ref: gitlab/gitlab-runner
        release_namespace: gitlab-runner
        values_files: runner_values.yml
        values:
          runnerRegistrationToken: "{{ lookup('env','RUNNER_TOKEN') }}"
          gitlabUrl: "http://{{ lookup('env','CI_SERVER_HOST') }}/"
          runners:
            tags: "{{ lookup('env','ENV') }}"
